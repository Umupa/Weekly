---
// TOC 组件 - 文章目录导航
// Sticky 定位，在文章右侧浮动显示
---

<nav class="toc" aria-label="文章目录" id="toc-nav">
  <header class="toc-header">
    <span class="toc-title">本期导读</span>
  </header>
  <ul class="toc-list" id="toc-list"></ul>
</nav>

<script>
  function initTOC() {
    const article = document.querySelector('article.content');
    const tocList = document.getElementById('toc-list');
    const tocNav = document.getElementById('toc-nav');

    if (!article || !tocList || !tocNav) return;

    // 提取所有 H2 和 H3 标题
    const headings = article.querySelectorAll('h2, h3');
    if (headings.length === 0) {
      // 没有标题时隐藏整个 TOC
      tocNav.style.display = 'none';
      return;
    }

    // 显示 TOC
    tocNav.style.display = 'block';

    // 为每个标题生成 ID（如果没有的话）
    headings.forEach((heading, index) => {
      if (!heading.id) {
        heading.id = `heading-${index}`;
      }
    });

    // 清空并生成目录列表
    tocList.innerHTML = '';
    const fragment = document.createDocumentFragment();
    headings.forEach((heading) => {
      const li = document.createElement('li');
      li.className = `toc-item toc-${heading.tagName.toLowerCase()}`;

      const a = document.createElement('a');
      a.href = `#${heading.id}`;
      a.textContent = heading.textContent || '';
      a.className = 'toc-link';

      li.appendChild(a);
      fragment.appendChild(li);
    });
    tocList.appendChild(fragment);

    // 使用 Intersection Observer 监听标题进入视口
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const id = entry.target.id;
          const tocLink = tocList.querySelector(`a[href="#${id}"]`);

          if (entry.isIntersecting) {
            // 移除所有 active 状态
            tocList.querySelectorAll('.toc-link').forEach((link) => {
              link.classList.remove('active');
            });
            // 添加当前 active 状态
            if (tocLink) {
              tocLink.classList.add('active');
            }
          }
        });
      },
      {
        rootMargin: '-80px 0px -70% 0px',
        threshold: 0,
      }
    );

    headings.forEach((heading) => observer.observe(heading));

    // 点击平滑滚动
    tocList.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.tagName === 'A') {
        e.preventDefault();
        const href = target.getAttribute('href');
        if (href) {
          const heading = document.querySelector(href);
          if (heading) {
            heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // 更新 URL hash
            history.pushState(null, '', href);
          }
        }
      }
    });
  }

  // 页面加载完成后初始化
  document.addEventListener('DOMContentLoaded', initTOC);
  // Astro View Transitions 支持
  document.addEventListener('astro:page-load', initTOC);
</script>

<style>
  .toc {
    display: none;
    position: sticky;
    top: 32px;
    max-height: calc(100vh - 64px);
    overflow-y: auto;
    font-size: 0.85rem;
    padding-left: 24px;
    border-left: 1px solid var(--border);
  }

  .toc-header {
    margin-bottom: 12px;
  }

  .toc-title {
    font-family: 'Noto Serif SC', serif;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 0.05em;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin: 0;
    line-height: 1.5;
  }

  .toc-h3 {
    padding-left: 1em;
  }

  .toc-link {
    display: block;
    padding: 4px 0;
    color: var(--text-secondary);
    text-decoration: none;
    transition: color 0.15s ease;
    opacity: 0.8;
  }

  .toc-link:hover {
    color: var(--text);
    opacity: 1;
  }

  .toc-link.active {
    color: var(--accent);
    font-weight: 500;
    opacity: 1;
  }

  /* 宽屏才显示 TOC */
  @media (min-width: 1200px) {
    .toc {
      display: block;
    }
  }
</style>
