---
// 赛博日历 - 可视化发布时间线
import { getAllPosts, getIssueNumber } from '@/lib/posts';

interface Props {
  currentDate?: string;
}

const { currentDate } = Astro.props;

// 获取所有文章的发布日期
const posts = await getAllPosts();
const publishedDates = posts.map((post) => ({
  date: post.data.date.toISOString().split('T')[0],
  number: getIssueNumber(post.id),
  title: post.data.title,
}));

// 统计发布周数
const totalWeeks = posts.length;
---

<div class="calendar">
  <header class="calendar-header">
    <span class="calendar-title">发布日历</span>
    <span class="calendar-stats">已发布 {totalWeeks} 期</span>
  </header>

  <div class="calendar-body" id="calendar-body">
    <!-- 由 JS 渲染日历 -->
  </div>

  <nav class="calendar-nav">
    <button class="calendar-btn" id="prev-month" aria-label="上个月">◀</button>
    <span class="calendar-current" id="calendar-current"></span>
    <button class="calendar-btn" id="next-month" aria-label="下个月">▶</button>
  </nav>
</div>

<script define:vars={{ publishedDates, currentDate }}>
  function initCalendar() {
    const body = document.getElementById('calendar-body');
    const currentLabel = document.getElementById('calendar-current');
    const prevBtn = document.getElementById('prev-month');
    const nextBtn = document.getElementById('next-month');

    if (!body || !currentLabel || !prevBtn || !nextBtn) return;

    // 创建日期到期刊的映射
    const dateMap = new Map();
    publishedDates.forEach((item) => {
      dateMap.set(item.date, item);
    });

    // 当前显示的年月
    let displayDate = currentDate ? new Date(currentDate) : new Date();
    let displayYear = displayDate.getFullYear();
    let displayMonth = displayDate.getMonth();

    function renderCalendar() {
      const year = displayYear;
      const month = displayMonth;

      // 更新标题
      currentLabel.textContent = `${year}年${month + 1}月`;

      // 计算本月第一天是星期几（0=周日）
      const firstDay = new Date(year, month, 1).getDay();
      // 本月天数
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // 生成日历 HTML
      let html = '<div class="calendar-weekdays">';
      const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
      weekdays.forEach((day) => {
        html += `<span class="weekday">${day}</span>`;
      });
      html += '</div><div class="calendar-days">';

      // 空白占位
      for (let i = 0; i < firstDay; i++) {
        html += '<span class="day empty"></span>';
      }

      // 日期
      const today = new Date().toISOString().split('T')[0];
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const post = dateMap.get(dateStr);
        const isToday = dateStr === today;
        const isCurrent = dateStr === currentDate;

        let classes = 'day';
        if (post) classes += ' has-post';
        if (isToday) classes += ' today';
        if (isCurrent) classes += ' current';

        if (post) {
          html += `<a href="/posts/${post.number}" class="${classes}" title="第${post.number}期: ${post.title}">${day}</a>`;
        } else {
          html += `<span class="${classes}">${day}</span>`;
        }
      }

      html += '</div>';
      body.innerHTML = html;
    }

    // 切换月份
    prevBtn.addEventListener('click', () => {
      displayMonth--;
      if (displayMonth < 0) {
        displayMonth = 11;
        displayYear--;
      }
      renderCalendar();
    });

    nextBtn.addEventListener('click', () => {
      displayMonth++;
      if (displayMonth > 11) {
        displayMonth = 0;
        displayYear++;
      }
      renderCalendar();
    });

    // 初始渲染
    renderCalendar();
  }

  document.addEventListener('DOMContentLoaded', initCalendar);
  document.addEventListener('astro:page-load', initCalendar);
</script>

<style>
  .calendar {
    font-size: 0.875rem;
  }

  .calendar-header {
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--text);
  }

  .calendar-title {
    font-family: 'Noto Serif SC', serif;
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    display: block;
  }

  .calendar-stats {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 4px;
    display: block;
  }

  .calendar-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .calendar-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px 8px;
    font-size: 0.75rem;
    transition: color 0.15s ease;
  }

  .calendar-btn:hover {
    color: var(--accent);
  }

  .calendar-current {
    font-size: 0.9rem;
    font-weight: 500;
  }

  .calendar-body :global(.calendar-weekdays) {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 8px;
  }

  .calendar-body :global(.weekday) {
    text-align: center;
    font-size: 0.7rem;
    color: var(--text-secondary);
    padding: 4px 0;
  }

  .calendar-body :global(.calendar-days) {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
  }

  .calendar-body :global(.day) {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    color: var(--text-secondary);
    border-radius: 2px;
    text-decoration: none;
  }

  .calendar-body :global(.day.empty) {
    visibility: hidden;
  }

  .calendar-body :global(.day.has-post) {
    background: var(--accent);
    color: white;
    font-weight: 500;
    cursor: pointer;
    transition: opacity 0.15s ease;
  }

  .calendar-body :global(.day.has-post:hover) {
    opacity: 0.85;
  }

  .calendar-body :global(.day.today) {
    outline: 1px solid var(--text);
    outline-offset: -1px;
  }

  .calendar-body :global(.day.current) {
    box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent);
  }
</style>
