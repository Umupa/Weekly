---
/**
 * Comment.astro - Giscus 评论组件
 * 基于 GitHub Discussions 的评论系统，支持三主题动态切换
 */

// Giscus 配置
const GISCUS_CONFIG = {
  repo: 'umupa/Weekly',
  repoId: 'R_kgDOQvdouA',
  category: 'Announcements',
  categoryId: 'DIC_kwDOQvdouM4C0T__',
  mapping: 'pathname',
  strict: '0',
  reactionsEnabled: '1',
  emitMetadata: '0',
  inputPosition: 'bottom',
  lang: 'zh-CN',
  loading: 'lazy',
};

// 主题 CSS 文件 URL 映射
const THEME_BASE_URL = 'https://cdn.jsdelivr.net/gh/umupa/Weekly@main/public';
---

<div class="giscus-wrapper" id="giscus-container"></div>

<script define:vars={{ GISCUS_CONFIG, THEME_BASE_URL }}>
  // 主题映射
  const themeMap = {
    light: `${THEME_BASE_URL}/giscus-light.css`,
    dark: `${THEME_BASE_URL}/giscus-dark.css`,
    paper: `${THEME_BASE_URL}/giscus-paper.css`,
  };

  // 获取当前主题
  function getCurrentTheme() {
    return document.documentElement.getAttribute('data-theme') || 'light';
  }

  // 获取 Giscus 主题 URL
  function getThemeUrl(theme) {
    return themeMap[theme] || themeMap.light;
  }

  // 加载 Giscus
  function loadGiscus() {
    const container = document.getElementById('giscus-container');
    if (!container) return;

    // 清空容器
    container.innerHTML = '';

    const currentTheme = getCurrentTheme();
    const themeUrl = getThemeUrl(currentTheme);

    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.setAttribute('data-repo', GISCUS_CONFIG.repo);
    script.setAttribute('data-repo-id', GISCUS_CONFIG.repoId);
    script.setAttribute('data-category', GISCUS_CONFIG.category);
    script.setAttribute('data-category-id', GISCUS_CONFIG.categoryId);
    script.setAttribute('data-mapping', GISCUS_CONFIG.mapping);
    script.setAttribute('data-strict', GISCUS_CONFIG.strict);
    script.setAttribute('data-reactions-enabled', GISCUS_CONFIG.reactionsEnabled);
    script.setAttribute('data-emit-metadata', GISCUS_CONFIG.emitMetadata);
    script.setAttribute('data-input-position', GISCUS_CONFIG.inputPosition);
    script.setAttribute('data-theme', themeUrl);
    script.setAttribute('data-lang', GISCUS_CONFIG.lang);
    script.setAttribute('data-loading', GISCUS_CONFIG.loading);
    script.setAttribute('crossorigin', 'anonymous');
    script.async = true;

    container.appendChild(script);
  }

  // 切换 Giscus 主题
  function updateGiscusTheme(theme) {
    const themeUrl = getThemeUrl(theme);
    const iframe = document.querySelector('iframe.giscus-frame');
    if (iframe && iframe.contentWindow) {
      iframe.contentWindow.postMessage(
        { giscus: { setConfig: { theme: themeUrl } } },
        'https://giscus.app'
      );
    }
  }

  // 监听主题变化
  function observeThemeChange() {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'data-theme') {
          const newTheme = getCurrentTheme();
          updateGiscusTheme(newTheme);
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-theme'],
    });
  }

  // 初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      loadGiscus();
      observeThemeChange();
    });
  } else {
    loadGiscus();
    observeThemeChange();
  }

  // Astro View Transitions 支持
  document.addEventListener('astro:page-load', () => {
    loadGiscus();
    observeThemeChange();
  });
</script>

<style>
  .giscus-wrapper {
    margin-top: 48px;
  }

  .giscus-wrapper :global(.giscus) {
    max-width: 100%;
  }

  .giscus-wrapper :global(.giscus-frame) {
    width: 100%;
    border: none;
  }

  @media (max-width: 768px) {
    .giscus-wrapper {
      margin-top: 32px;
      padding-top: 24px;
    }
  }
</style>
